class X{canvas;simulation;callbacks;mode="view";selection=null;isSelecting=!1;isDrawing=!1;isDragging=!1;draggedCreature=null;ghostPreview=null;brushSize=3;brushIntensity=0.5;constructor(q,K,Q,Z={}){this.canvas=q,this.simulation=K,this.callbacks=Z,this.setupEventListeners(),this.setupDragDrop()}setMode(q){switch(this.mode=q,this.selection=null,this.isSelecting=!1,this.isDrawing=!1,q){case"select":this.canvas.style.cursor="crosshair";break;case"draw":this.canvas.style.cursor="cell";break;case"erase":this.canvas.style.cursor="not-allowed";break;default:this.canvas.style.cursor="default"}this.callbacks.onModeChange?.(q)}getMode(){return this.mode}getSelection(){return this.selection}clearSelection(){this.selection=null,this.callbacks.onSelectionChange?.(null)}setBrushSize(q){this.brushSize=Math.max(1,Math.min(20,q))}setBrushIntensity(q){this.brushIntensity=Math.max(0,Math.min(1,q))}getGhostPreview(){return this.ghostPreview}startDragFromLibrary(q,K){this.isDragging=!0,this.draggedCreature={preset:q,offsetX:q.region.width/2,offsetY:q.region.height/2};let Q=this.getSimCoords(K);this.ghostPreview={region:q.region,x:Q.x-this.draggedCreature.offsetX,y:Q.y-this.draggedCreature.offsetY}}setupEventListeners(){this.canvas.addEventListener("mousedown",this.handleMouseDown.bind(this)),this.canvas.addEventListener("mousemove",this.handleMouseMove.bind(this)),this.canvas.addEventListener("mouseup",this.handleMouseUp.bind(this)),this.canvas.addEventListener("mouseleave",this.handleMouseLeave.bind(this)),document.addEventListener("keydown",this.handleKeyDown.bind(this))}setupDragDrop(){this.canvas.addEventListener("dragover",(q)=>{if(q.preventDefault(),q.dataTransfer.dropEffect="copy",this.draggedCreature){let K=this.getSimCoords(q);this.ghostPreview={region:this.draggedCreature.preset.region,x:K.x-this.draggedCreature.offsetX,y:K.y-this.draggedCreature.offsetY}}}),this.canvas.addEventListener("drop",(q)=>{if(q.preventDefault(),this.draggedCreature){let K=this.getSimCoords(q),Q=Math.floor(K.x-this.draggedCreature.offsetX),Z=Math.floor(K.y-this.draggedCreature.offsetY);this.callbacks.onDrop?.(this.draggedCreature.preset,Q,Z),this.draggedCreature=null,this.ghostPreview=null,this.isDragging=!1}}),this.canvas.addEventListener("dragleave",()=>{this.ghostPreview=null})}handleMouseDown(q){let K=this.getSimCoords(q);switch(this.mode){case"select":this.isSelecting=!0,this.selection={startX:K.x,startY:K.y,endX:K.x,endY:K.y},this.callbacks.onSelectionChange?.(this.selection);break;case"draw":this.isDrawing=!0,this.callbacks.onDraw?.(K.x,K.y);break;case"erase":this.isDrawing=!0,this.callbacks.onErase?.(K.x,K.y);break}}handleMouseMove(q){let K=this.getSimCoords(q);if(this.isSelecting&&this.selection)this.selection.endX=K.x,this.selection.endY=K.y,this.callbacks.onSelectionChange?.(this.selection);if(this.isDrawing){if(this.mode==="draw")this.callbacks.onDraw?.(K.x,K.y);else if(this.mode==="erase")this.callbacks.onErase?.(K.x,K.y)}if(this.isDragging&&this.draggedCreature)this.ghostPreview={region:this.draggedCreature.preset.region,x:K.x-this.draggedCreature.offsetX,y:K.y-this.draggedCreature.offsetY}}handleMouseUp(q){if(this.isSelecting&&this.selection){let K={startX:Math.min(this.selection.startX,this.selection.endX),startY:Math.min(this.selection.startY,this.selection.endY),endX:Math.max(this.selection.startX,this.selection.endX),endY:Math.max(this.selection.startY,this.selection.endY)};if(K.endX>K.startX&&K.endY>K.startY)this.selection=K,this.callbacks.onSelectionComplete?.(K);else this.selection=null;this.callbacks.onSelectionChange?.(this.selection)}this.isSelecting=!1,this.isDrawing=!1}handleMouseLeave(q){if(this.isSelecting)this.isSelecting=!1,this.selection=null,this.callbacks.onSelectionChange?.(null);this.isDrawing=!1,this.ghostPreview=null}handleKeyDown(q){let K=q.target;if(K.tagName==="INPUT"||K.tagName==="TEXTAREA")return;if(q.key==="v"||q.key==="Escape")this.setMode("view");else if(q.key==="s")this.setMode("select");else if(q.key==="d")this.setMode("draw");else if(q.key==="e")this.setMode("erase");if(q.key==="[")this.setBrushSize(this.brushSize-1),this.callbacks.onBrushSizeChange?.(this.brushSize);else if(q.key==="]")this.setBrushSize(this.brushSize+1),this.callbacks.onBrushSizeChange?.(this.brushSize)}getSimCoords(q){let K=this.canvas.getBoundingClientRect(),Q=q.clientX-K.left,Z=q.clientY-K.top,$=this.simulation.getWidth(),O=this.simulation.getHeight();return{x:Math.floor(Q/K.width*$),y:Math.floor(Z/K.height*O)}}getBrushSize(){return this.brushSize}getBrushIntensity(){return this.brushIntensity}}class Y{presets=new Map;listeners=new Set;constructor(){this.loadFromStorage()}generateId(){return`preset-${Date.now()}-${Math.random().toString(36).slice(2,9)}`}createThumbnail(q,K=64){let Q=document.createElement("canvas");Q.width=K,Q.height=K;let Z=Q.getContext("2d"),$=Z.createImageData(q.width,q.height),O=q.channels[0];for(let R=0;R<O.length;R++){let N=Math.max(0,Math.min(1,O[R])),E=Math.floor(N*255);$.data[R*4+0]=E,$.data[R*4+1]=E,$.data[R*4+2]=E,$.data[R*4+3]=255}let A=document.createElement("canvas");A.width=q.width,A.height=q.height,A.getContext("2d").putImageData($,0,0),Z.imageSmoothingEnabled=!0,Z.fillStyle="#1a1a1a",Z.fillRect(0,0,K,K);let G=Math.min(K/q.width,K/q.height),V=q.width*G,_=q.height*G,F=(K-V)/2,j=(K-_)/2;return Z.drawImage(A,F,j,V,_),Q.toDataURL("image/png")}savePreset(q,K,Q){let Z={id:this.generateId(),name:q,description:Q,thumbnail:this.createThumbnail(K),region:K,createdAt:Date.now()};return this.presets.set(Z.id,Z),this.persistToStorage(),this.notifyListeners(),Z}getPreset(q){return this.presets.get(q)}getAllPresets(){return Array.from(this.presets.values()).sort((q,K)=>K.createdAt-q.createdAt)}deletePreset(q){let K=this.presets.delete(q);if(K)this.persistToStorage(),this.notifyListeners();return K}renamePreset(q,K){let Q=this.presets.get(q);if(Q)return Q.name=K,this.persistToStorage(),this.notifyListeners(),!0;return!1}updateDescription(q,K){let Q=this.presets.get(q);if(Q)return Q.description=K,this.persistToStorage(),this.notifyListeners(),!0;return!1}exportPresets(q){let K=q?q.map((Q)=>this.presets.get(Q)).filter(Boolean):this.getAllPresets();return JSON.stringify(K,null,2)}importPresets(q){try{let K=JSON.parse(q),Q=0;for(let Z of K){let $={...Z,id:this.generateId(),createdAt:Date.now()};this.presets.set($.id,$),Q++}return this.persistToStorage(),this.notifyListeners(),Q}catch{throw Error("Invalid preset JSON format")}}subscribe(q){return this.listeners.add(q),()=>this.listeners.delete(q)}notifyListeners(){let q=this.getAllPresets();for(let K of this.listeners)K(q)}persistToStorage(){try{let q=JSON.stringify(Array.from(this.presets.entries()));localStorage.setItem("flow-lenia-presets",q)}catch(q){console.warn("Failed to persist presets to storage:",q)}}loadFromStorage(){try{let q=localStorage.getItem("flow-lenia-presets");if(q){let K=JSON.parse(q);this.presets=new Map(K)}}catch(q){console.warn("Failed to load presets from storage:",q),this.presets=new Map}}clearAll(){this.presets.clear(),this.persistToStorage(),this.notifyListeners()}}var H=[{name:"Glider",description:"A simple glider that moves across the grid",seed:{pattern:{type:"GaussianBlob",center:[0.5,0.5],radius:0.1,amplitude:1,channel:0}}},{name:"Ring",description:"A ring pattern that expands",seed:{pattern:{type:"Ring",center:[0.5,0.5],inner_radius:0.05,outer_radius:0.1,amplitude:1,channel:0}}},{name:"Dual Blobs",description:"Two interacting blobs",seed:{pattern:{type:"MultiBlob",blobs:[{center:[0.35,0.5],radius:0.08,amplitude:1,channel:0},{center:[0.65,0.5],radius:0.08,amplitude:1,channel:0}]}}},{name:"Random Noise",description:"Random initial conditions",seed:{pattern:{type:"Noise",seed:42,amplitude:0.5,channel:0}}}];class T{canvas;ctx;offscreenCanvas;offscreenCtx;settings;grayscaleMap;thermalMap;viridisMap;constructor(q,K){this.canvas=q;let Q=q.getContext("2d");if(!Q)throw Error("Failed to get 2D context");this.ctx=Q,this.offscreenCanvas=document.createElement("canvas");let Z=this.offscreenCanvas.getContext("2d");if(!Z)throw Error("Failed to get offscreen 2D context");this.offscreenCtx=Z,this.settings=K,this.grayscaleMap=this.buildGrayscaleMap(),this.thermalMap=this.buildThermalMap(),this.viridisMap=this.buildViridisMap()}updateSettings(q){this.settings={...this.settings,...q}}render(q,K,Q){let{width:Z,height:$,channels:O}=q;if(this.offscreenCanvas.width!==Z||this.offscreenCanvas.height!==$)this.offscreenCanvas.width=Z,this.offscreenCanvas.height=$;let A=this.getColorMap(),J=this.offscreenCtx.createImageData(Z,$),G=O[0];for(let V=0;V<G.length;V++){let _=Math.max(0,Math.min(1,G[V])),F=Math.floor(_*255)*4;J.data[V*4+0]=A[F+0],J.data[V*4+1]=A[F+1],J.data[V*4+2]=A[F+2],J.data[V*4+3]=255}if(this.offscreenCtx.putImageData(J,0,0),this.ctx.imageSmoothingEnabled=!1,this.ctx.fillStyle="#000",this.ctx.fillRect(0,0,this.canvas.width,this.canvas.height),this.ctx.drawImage(this.offscreenCanvas,0,0,Z,$,0,0,this.canvas.width,this.canvas.height),this.settings.showGrid)this.drawGrid(Z,$);if(Q)this.drawGhostPreview(Q,Z,$);if(K&&this.settings.showSelection)this.drawSelection(K,Z,$)}drawGrid(q,K){let Q=this.canvas.width/q,Z=this.canvas.height/K;if(this.ctx.strokeStyle="rgba(255, 255, 255, 0.1)",this.ctx.lineWidth=1,Q>=4&&Z>=4){this.ctx.beginPath();for(let $=0;$<=q;$++){let O=$*Q;this.ctx.moveTo(O,0),this.ctx.lineTo(O,this.canvas.height)}for(let $=0;$<=K;$++){let O=$*Z;this.ctx.moveTo(0,O),this.ctx.lineTo(this.canvas.width,O)}this.ctx.stroke()}}drawSelection(q,K,Q){let Z=this.canvas.width/K,$=this.canvas.height/Q,O=Math.min(q.startX,q.endX)*Z,A=Math.min(q.startY,q.endY)*$,J=Math.abs(q.endX-q.startX)*Z,G=Math.abs(q.endY-q.startY)*$;this.ctx.fillStyle="rgba(79, 195, 247, 0.2)",this.ctx.fillRect(O,A,J,G),this.ctx.strokeStyle="#4fc3f7",this.ctx.lineWidth=2,this.ctx.setLineDash([5,5]),this.ctx.strokeRect(O,A,J,G),this.ctx.setLineDash([]);let V=Math.abs(q.endX-q.startX),_=Math.abs(q.endY-q.startY);if(V>0&&_>0)this.ctx.fillStyle="#4fc3f7",this.ctx.font="12px monospace",this.ctx.fillText(`${V} x ${_}`,O+4,A-4)}drawGhostPreview(q,K,Q){let Z=this.canvas.width/K,$=this.canvas.height/Q,{region:O,x:A,y:J}=q,G=document.createElement("canvas");G.width=O.width,G.height=O.height;let V=G.getContext("2d"),_=V.createImageData(O.width,O.height),F=this.getColorMap();for(let j=0;j<O.channels[0].length;j++){let R=Math.max(0,Math.min(1,O.channels[0][j])),N=Math.floor(R*255)*4;_.data[j*4+0]=F[N+0],_.data[j*4+1]=F[N+1],_.data[j*4+2]=F[N+2],_.data[j*4+3]=R>0.01?180:0}V.putImageData(_,0,0),this.ctx.globalAlpha=0.7,this.ctx.drawImage(G,0,0,O.width,O.height,A*Z,J*$,O.width*Z,O.height*$),this.ctx.globalAlpha=1,this.ctx.strokeStyle="#4fc3f7",this.ctx.lineWidth=2,this.ctx.setLineDash([3,3]),this.ctx.strokeRect(A*Z,J*$,O.width*Z,O.height*$),this.ctx.setLineDash([])}canvasToSim(q,K,Q,Z){let $=this.canvas.getBoundingClientRect(),O=Q/this.canvas.width,A=Z/this.canvas.height;return{x:Math.floor((q-$.left)*O),y:Math.floor((K-$.top)*A)}}getColorMap(){switch(this.settings.colorScheme){case"thermal":return this.thermalMap;case"viridis":return this.viridisMap;default:return this.grayscaleMap}}buildGrayscaleMap(){let q=new Uint8ClampedArray(1024);for(let K=0;K<256;K++)q[K*4+0]=K,q[K*4+1]=K,q[K*4+2]=K,q[K*4+3]=255;return q}buildThermalMap(){let q=new Uint8ClampedArray(1024);for(let K=0;K<256;K++){let Q=K/255,Z,$,O;if(Q<0.2){let A=Q/0.2;Z=0,$=0,O=Math.floor(A*128)}else if(Q<0.4){let A=(Q-0.2)/0.2;Z=0,$=Math.floor(A*255),O=128+Math.floor(A*127)}else if(Q<0.6){let A=(Q-0.4)/0.2;Z=Math.floor(A*255),$=255,O=255-Math.floor(A*255)}else if(Q<0.8){let A=(Q-0.6)/0.2;Z=255,$=255-Math.floor(A*255),O=0}else{let A=(Q-0.8)/0.2;Z=255,$=Math.floor(A*255),O=Math.floor(A*255)}q[K*4+0]=Z,q[K*4+1]=$,q[K*4+2]=O,q[K*4+3]=255}return q}buildViridisMap(){let q=[[68,1,84],[72,35,116],[64,67,135],[52,94,141],[41,120,142],[32,144,140],[34,167,132],[68,190,112],[121,209,81],[189,222,38],[253,231,36]],K=new Uint8ClampedArray(1024);for(let Q=0;Q<256;Q++){let $=Q/255*(q.length-1),O=Math.floor($),A=Math.min(O+1,q.length-1),J=$-O;K[Q*4+0]=Math.floor(q[O][0]+J*(q[A][0]-q[O][0])),K[Q*4+1]=Math.floor(q[O][1]+J*(q[A][1]-q[O][1])),K[Q*4+2]=Math.floor(q[O][2]+J*(q[A][2]-q[O][2])),K[Q*4+3]=255}return K}getCanvas(){return this.canvas}}class I{propagator=null;config;currentSeed;isInitialized=!1;wasmModule=null;currentBackend="cpu";gpuAvailable=!1;constructor(q,K){this.config=q,this.currentSeed=K}async initialize(q="cpu"){try{let K=new URL("./pkg/flow_lenia.js",import.meta.url).href;this.wasmModule=await import(K),await this.wasmModule.default(),this.gpuAvailable=await this.checkWebGPU();let Q=q==="gpu"&&this.gpuAvailable?"gpu":"cpu";await this.createPropagator(Q),this.isInitialized=!0}catch(K){throw Error(`Failed to initialize WASM: ${K}`)}}async checkWebGPU(){if(typeof navigator>"u"||!("gpu"in navigator))return!1;try{return await navigator.gpu.requestAdapter()!==null}catch{return!1}}async createPropagator(q){if(!this.wasmModule)throw Error("WASM module not loaded");let K=JSON.stringify(this.config),Q=JSON.stringify(this.currentSeed);if(q==="gpu"&&this.gpuAvailable)this.propagator=await new this.wasmModule.WasmGpuPropagator(K,Q),this.currentBackend="gpu";else this.propagator=new this.wasmModule.WasmPropagator(K,Q),this.currentBackend="cpu"}async switchBackend(q){if(!this.isInitialized)throw Error("Simulation not initialized");if(q==="gpu"&&!this.gpuAvailable)return!1;if(q===this.currentBackend)return!0;return await this.createPropagator(q),!0}isGpuAvailable(){return this.gpuAvailable}getBackend(){return this.currentBackend}async step(){if(this.ensureInitialized(),this.currentBackend==="gpu")await this.propagator.step();else this.propagator.step()}async run(q){if(this.ensureInitialized(),this.currentBackend==="gpu")await this.propagator.run(BigInt(q));else this.propagator.run(BigInt(q))}getState(){return this.ensureInitialized(),this.propagator.getState()}reset(q){if(this.ensureInitialized(),q)this.currentSeed=q;this.propagator.reset(JSON.stringify(this.currentSeed))}totalMass(){return this.ensureInitialized(),this.propagator.totalMass()}getTime(){return this.ensureInitialized(),this.propagator.getTime()}getStep(){return this.ensureInitialized(),this.propagator.getStep()}getWidth(){return this.config.width}getHeight(){return this.config.height}getConfig(){return{...this.config}}extractRegion(q,K,Q,Z){this.ensureInitialized();let $=this.getState(),O=[];for(let A=0;A<$.channels.length;A++){let J=[];for(let G=0;G<Z;G++)for(let V=0;V<Q;V++){let _=(q+V)%$.width,j=(K+G)%$.height*$.width+_;J.push($.channels[A][j])}O.push(J)}return{width:Q,height:Z,channels:O,sourceX:q,sourceY:K}}placeRegion(q,K,Q){this.ensureInitialized();let Z=this.getState(),$=new Map;for(let J=0;J<Z.channels.length;J++)for(let G=0;G<Z.height;G++)for(let V=0;V<Z.width;V++){let _=G*Z.width+V,F=Z.channels[J][_];if(F>0.001)$.set(`${V},${G},${J}`,F)}for(let J=0;J<q.channels.length;J++)for(let G=0;G<q.height;G++)for(let V=0;V<q.width;V++){let _=(K+V)%this.config.width,F=(Q+G)%this.config.height,j=G*q.width+V,R=q.channels[J][j];if(R>0.001)$.set(`${_},${F},${J}`,R)}let O=[];for(let[J,G]of $){let[V,_,F]=J.split(",").map(Number);O.push([V,_,F,G])}let A={pattern:{type:"Custom",values:O}};this.reset(A)}drawAt(q,K,Q,Z,$=0){this.ensureInitialized();let O=this.getState(),A=[];for(let G=0;G<O.channels.length;G++)for(let V=0;V<O.height;V++)for(let _=0;_<O.width;_++){let F=V*O.width+_,j=O.channels[G][F];if(G===$){let R=_-q,N=V-K,E=Math.sqrt(R*R+N*N);if(E<=Q){let L=1-E/Q;j=Math.min(1,j+Z*L*L)}}if(j>0.001)A.push([_,V,G,j])}let J={pattern:{type:"Custom",values:A}};this.reset(J)}eraseAt(q,K,Q,Z=0){this.ensureInitialized();let $=this.getState(),O=[];for(let J=0;J<$.channels.length;J++)for(let G=0;G<$.height;G++)for(let V=0;V<$.width;V++){let _=G*$.width+V,F=$.channels[J][_];if(J===Z){let j=V-q,R=G-K,N=Math.sqrt(j*j+R*R);if(N<=Q){let E=1-N/Q;F=Math.max(0,F*(1-E*E))}}if(F>0.001)O.push([V,G,J,F])}let A={pattern:{type:"Custom",values:O}};this.reset(A)}ensureInitialized(){if(!this.isInitialized||!this.propagator)throw Error("Simulation not initialized. Call initialize() first.")}}function P(q){return q.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#039;")}class B{container;callbacks;isPlaying=!1;stepsPerSecond=60;hasSelection=!1;constructor(q,K){this.container=q,this.callbacks=K,this.buildUI()}buildUI(){this.container.innerHTML=`
      <div class="viewer-layout">
        <aside class="sidebar left-sidebar">
          <div class="panel">
            <h3>Playback</h3>
            <div class="button-group">
              <button id="playBtn" class="btn btn-primary" title="Play (Space)">
                <span class="icon">▶</span> Play
              </button>
              <button id="pauseBtn" class="btn" disabled title="Pause (Space)">
                <span class="icon">⏸</span> Pause
              </button>
            </div>
            <div class="button-group">
              <button id="stepBtn" class="btn" title="Step (.)">
                <span class="icon">⏭</span> Step
              </button>
              <button id="resetBtn" class="btn" title="Reset (R)">
                <span class="icon">↺</span> Reset
              </button>
            </div>
            <div class="speed-control">
              <label>Speed: <span id="speedValue">60</span> steps/sec</label>
              <div class="button-group">
                <button id="slowDownBtn" class="btn btn-sm">−</button>
                <button id="speedUpBtn" class="btn btn-sm">+</button>
              </div>
            </div>
          </div>

          <div class="panel">
            <h3>Tools</h3>
            <div class="tool-buttons">
              <button id="viewModeBtn" class="btn tool-btn active" title="View Mode (V)">
                <span class="icon">\uD83D\uDC41</span> View
              </button>
              <button id="selectModeBtn" class="btn tool-btn" title="Select Mode (S)">
                <span class="icon">⬚</span> Select
              </button>
              <button id="drawModeBtn" class="btn tool-btn" title="Draw Mode (D)">
                <span class="icon">✎</span> Draw
              </button>
              <button id="eraseModeBtn" class="btn tool-btn" title="Erase Mode (E)">
                <span class="icon">⌫</span> Erase
              </button>
            </div>
            <div id="brushSettings" class="brush-settings hidden">
              <label>Brush Size: <span id="brushSizeValue">3</span></label>
              <input type="range" id="brushSizeSlider" min="1" max="20" value="3">
              <label>Intensity: <span id="brushIntensityValue">50</span>%</label>
              <input type="range" id="brushIntensitySlider" min="0" max="100" value="50">
            </div>
          </div>

          <div class="panel">
            <h3>Display</h3>
            <div class="setting-row">
              <label>Color Scheme</label>
              <select id="colorScheme">
                <option value="grayscale">Grayscale</option>
                <option value="thermal">Thermal</option>
                <option value="viridis">Viridis</option>
              </select>
            </div>
            <div class="setting-row">
              <label>
                <input type="checkbox" id="showGrid"> Show Grid
              </label>
            </div>
          </div>
        </aside>

        <main class="canvas-container">
          <canvas id="simulationCanvas" width="512" height="512"></canvas>
          <div class="stats-bar">
            <span>Step: <strong id="stepCount">0</strong></span>
            <span>Time: <strong id="simTime">0.00</strong></span>
            <span>Mass: <strong id="totalMass">0.00</strong></span>
            <span>FPS: <strong id="fpsDisplay">0</strong></span>
            <div class="backend-toggle">
              <span class="backend-label cpu active" id="cpuLabel">CPU</span>
              <label class="toggle-switch">
                <input type="checkbox" id="backendToggle" disabled>
                <span class="toggle-slider"></span>
              </label>
              <span class="backend-label gpu" id="gpuLabel">GPU</span>
            </div>
          </div>
        </main>

        <aside class="sidebar right-sidebar">
          <div class="panel">
            <h3>Selection</h3>
            <div id="selectionInfo" class="selection-info">
              <p class="muted">Use Select tool to capture regions</p>
            </div>
            <div id="saveSelectionForm" class="save-form hidden">
              <input type="text" id="presetName" placeholder="Preset name..." maxlength="30">
              <button id="savePresetBtn" class="btn btn-primary" disabled>Save as Preset</button>
            </div>
          </div>

          <div class="panel">
            <h3>Presets</h3>
            <div class="preset-actions">
              <button id="importPresetsBtn" class="btn btn-sm">Import</button>
              <button id="exportPresetsBtn" class="btn btn-sm">Export</button>
            </div>
            <div id="presetLibrary" class="preset-library">
              <!-- Presets will be rendered here -->
            </div>
            <input type="file" id="importFileInput" accept=".json" hidden>
          </div>

          <div class="panel">
            <h3>Built-in Patterns</h3>
            <div id="builtinPatterns" class="builtin-patterns">
              <!-- Built-in patterns will be rendered here -->
            </div>
          </div>
        </aside>
      </div>
    `,this.setupEventListeners(),this.renderBuiltinPatterns()}setupEventListeners(){let q=this.get("playBtn"),K=this.get("pauseBtn"),Q=this.get("stepBtn"),Z=this.get("resetBtn"),$=this.get("speedUpBtn"),O=this.get("slowDownBtn");q.addEventListener("click",()=>{this.callbacks.onPlay(),this.setPlaying(!0)}),K.addEventListener("click",()=>{this.callbacks.onPause(),this.setPlaying(!1)}),Q.addEventListener("click",()=>this.callbacks.onStep()),Z.addEventListener("click",()=>this.callbacks.onReset()),$.addEventListener("click",()=>{this.stepsPerSecond=Math.min(this.stepsPerSecond*2,480),this.updateSpeedDisplay(),this.callbacks.onSpeedChange(this.stepsPerSecond)}),O.addEventListener("click",()=>{this.stepsPerSecond=Math.max(Math.floor(this.stepsPerSecond/2),15),this.updateSpeedDisplay(),this.callbacks.onSpeedChange(this.stepsPerSecond)});let A=this.get("viewModeBtn"),J=this.get("selectModeBtn"),G=this.get("drawModeBtn"),V=this.get("eraseModeBtn");A.addEventListener("click",()=>this.setMode("view")),J.addEventListener("click",()=>this.setMode("select")),G.addEventListener("click",()=>this.setMode("draw")),V.addEventListener("click",()=>this.setMode("erase"));let _=this.get("brushSizeSlider"),F=this.get("brushIntensitySlider");_.addEventListener("input",()=>{let U=parseInt(_.value,10);this.get("brushSizeValue").textContent=U.toString(),this.callbacks.onBrushSizeChange(U)}),F.addEventListener("input",()=>{let U=parseInt(F.value,10);this.get("brushIntensityValue").textContent=U.toString(),this.callbacks.onBrushIntensityChange(U/100)});let j=this.get("colorScheme"),R=this.get("showGrid");j.addEventListener("change",()=>{this.callbacks.onSettingsChange({colorScheme:j.value})}),R.addEventListener("change",()=>{this.callbacks.onSettingsChange({showGrid:R.checked})});let N=this.get("presetName"),E=this.get("savePresetBtn");N.addEventListener("input",()=>{E.disabled=!N.value.trim()||!this.hasSelection}),E.addEventListener("click",()=>{let U=N.value.trim();if(U)this.callbacks.onSaveSelection(U),N.value="",E.disabled=!0});let L=this.get("importPresetsBtn"),C=this.get("exportPresetsBtn"),M=this.get("importFileInput");L.addEventListener("click",()=>M.click()),M.addEventListener("change",()=>{let U=M.files?.[0];if(U){let W=new FileReader;W.onload=()=>{this.callbacks.onImportPresets(W.result)},W.readAsText(U),M.value=""}}),C.addEventListener("click",()=>this.callbacks.onExportPresets());let D=this.get("backendToggle");D.addEventListener("change",()=>{let U=D.checked?"gpu":"cpu";this.callbacks.onBackendChange(U)}),document.addEventListener("keydown",(U)=>{if(U.target.tagName==="INPUT")return;if(U.key===" ")if(U.preventDefault(),this.isPlaying)this.callbacks.onPause(),this.setPlaying(!1);else this.callbacks.onPlay(),this.setPlaying(!0);else if(U.key===".")this.callbacks.onStep();else if(U.key==="r"||U.key==="R")this.callbacks.onReset()})}renderBuiltinPatterns(){let q=this.get("builtinPatterns");q.innerHTML=H.map((K)=>`
      <div class="builtin-pattern" data-name="${K.name}">
        <span class="pattern-name">${K.name}</span>
        <span class="pattern-desc">${K.description}</span>
      </div>
    `).join(""),q.querySelectorAll(".builtin-pattern").forEach((K)=>{K.addEventListener("click",()=>{let Q=K.getAttribute("data-name"),Z=H.find(($)=>$.name===Q);if(Z)this.callbacks.onReset(Z.seed)})})}updateModeDisplay(q){let K={view:this.get("viewModeBtn"),select:this.get("selectModeBtn"),draw:this.get("drawModeBtn"),erase:this.get("eraseModeBtn")};for(let[Z,$]of Object.entries(K))$.classList.toggle("active",Z===q);this.get("brushSettings").classList.toggle("hidden",q!=="draw"&&q!=="erase")}setMode(q){this.updateModeDisplay(q),this.callbacks.onModeChange(q)}setPlaying(q){this.isPlaying=q;let K=this.get("playBtn"),Q=this.get("pauseBtn");K.disabled=q,Q.disabled=!q}updateStats(q,K,Q,Z){this.get("stepCount").textContent=q.toString(),this.get("simTime").textContent=K.toFixed(2),this.get("totalMass").textContent=Q.toFixed(2),this.get("fpsDisplay").textContent=Z.toString()}updateSelection(q,K,Q){this.hasSelection=q;let Z=this.get("selectionInfo"),$=this.get("saveSelectionForm"),O=this.get("savePresetBtn"),A=this.get("presetName");if(q&&K&&Q)Z.innerHTML=`<p>Selection: <strong>${K} x ${Q}</strong> cells</p>`,$.classList.remove("hidden"),O.disabled=!A.value.trim();else Z.innerHTML='<p class="muted">Use Select tool to capture regions</p>',$.classList.add("hidden")}renderPresets(q){let K=this.get("presetLibrary");if(q.length===0){K.innerHTML='<p class="muted">No saved presets</p>';return}K.innerHTML=q.map((Q)=>`
      <div class="preset-item" data-id="${P(Q.id)}" draggable="true">
        <img src="${P(Q.thumbnail)}" alt="${P(Q.name)}" class="preset-thumbnail">
        <div class="preset-info">
          <span class="preset-name">${P(Q.name)}</span>
          <span class="preset-size">${Q.region.width}x${Q.region.height}</span>
        </div>
        <button class="btn btn-sm btn-danger delete-preset" title="Delete">×</button>
      </div>
    `).join(""),K.querySelectorAll(".preset-item").forEach((Q)=>{let Z=Q.getAttribute("data-id"),$=q.find((O)=>O.id===Z);Q.addEventListener("click",(O)=>{if(!O.target.classList.contains("delete-preset"))this.callbacks.onPresetSelect($)}),Q.addEventListener("dragstart",(O)=>{this.callbacks.onPresetDragStart($,O)}),Q.querySelector(".delete-preset")?.addEventListener("click",(O)=>{if(O.stopPropagation(),confirm(`Delete preset "${$.name}"?`))this.callbacks.onPresetDelete(Z)})})}updateSpeedDisplay(){this.get("speedValue").textContent=this.stepsPerSecond.toString()}get(q){let K=document.getElementById(q);if(!K)throw Error(`Element #${q} not found`);return K}getCanvas(){return this.get("simulationCanvas")}setGpuAvailable(q){let K=this.get("backendToggle"),Q=this.get("gpuLabel");K.disabled=!q,Q.classList.toggle("unavailable",!q),Q.title=q?"GPU backend":"GPU not available"}updateBackend(q){let K=this.get("backendToggle"),Q=this.get("cpuLabel"),Z=this.get("gpuLabel");K.checked=q==="gpu",Q.classList.toggle("active",q==="cpu"),Z.classList.toggle("active",q==="gpu")}updateBrushSize(q){let K=this.get("brushSizeSlider"),Q=this.get("brushSizeValue");K.value=q.toString(),Q.textContent=q.toString()}}var f={width:128,height:128,channels:1,dt:0.05,kernel_radius:13,kernels:[{radius:1,rings:[{amplitude:1,distance:0.5,width:0.15}],weight:1,mu:0.15,sigma:0.015,source_channel:0,target_channel:0}],flow:{beta_a:2,n:4,distribution_size:0.5}},k={pattern:{type:"GaussianBlob",center:[0.5,0.5],radius:0.1,amplitude:1,channel:0}};class S{simulation;renderer;interaction;presetManager;ui;settings={colorScheme:"grayscale",showGrid:!1,showSelection:!0,brushSize:3,brushIntensity:0.5,backend:"cpu"};isPlaying=!1;stepsPerSecond=60;animationFrameId=null;frameCount=0;fpsUpdateTime=0;currentFps=0;lastFrameTime=0;stepAccumulator=0;constructor(){this.simulation=new I(f,k),this.presetManager=new Y}async initialize(){let q=document.getElementById("app");if(!q)throw Error("App container not found");q.innerHTML='<div class="loading">Loading WebAssembly module...</div>';try{await this.simulation.initialize(),this.ui=new B(q,{onPlay:()=>this.play(),onPause:()=>this.pause(),onStep:()=>this.step(),onReset:(Q)=>this.reset(Q),onSpeedChange:(Q)=>{this.stepsPerSecond=Q},onModeChange:(Q)=>this.setMode(Q),onSettingsChange:(Q)=>this.updateSettings(Q),onSaveSelection:(Q)=>this.saveSelection(Q),onPresetSelect:(Q)=>this.selectPreset(Q),onPresetDelete:(Q)=>this.deletePreset(Q),onPresetDragStart:(Q,Z)=>this.startPresetDrag(Q,Z),onExportPresets:()=>this.exportPresets(),onImportPresets:(Q)=>this.importPresets(Q),onBrushSizeChange:(Q)=>{this.settings.brushSize=Q,this.interaction.setBrushSize(Q)},onBrushIntensityChange:(Q)=>{this.settings.brushIntensity=Q,this.interaction.setBrushIntensity(Q)},onBackendChange:(Q)=>this.switchBackend(Q)});let K=this.ui.getCanvas();this.renderer=new T(K,this.settings),this.interaction=new X(K,this.simulation,this.renderer,{onSelectionChange:(Q)=>{if(Q){let Z=Math.abs(Q.endX-Q.startX),$=Math.abs(Q.endY-Q.startY);this.ui.updateSelection(Z>0&&$>0,Z,$)}else this.ui.updateSelection(!1);this.render()},onSelectionComplete:(Q)=>{},onDrop:(Q,Z,$)=>{this.simulation.placeRegion(Q.region,Z,$),this.render()},onDraw:(Q,Z)=>{this.simulation.drawAt(Q,Z,this.settings.brushSize,this.settings.brushIntensity),this.render()},onErase:(Q,Z)=>{this.simulation.eraseAt(Q,Z,this.settings.brushSize),this.render()},onModeChange:(Q)=>{this.ui.updateModeDisplay(Q)},onBrushSizeChange:(Q)=>{this.settings.brushSize=Q,this.ui.updateBrushSize(Q)}}),this.presetManager.subscribe((Q)=>{this.ui.renderPresets(Q)}),this.ui.setGpuAvailable(this.simulation.isGpuAvailable()),this.ui.updateBackend(this.simulation.getBackend()),this.settings.backend=this.simulation.getBackend(),this.ui.renderPresets(this.presetManager.getAllPresets()),this.render(),this.updateStats(),console.log("Flow Lenia Viewer initialized successfully")}catch(K){throw q.innerHTML=`
        <div class="error">
          <h2>Initialization Error</h2>
          <p>${K}</p>
          <p>Make sure WASM is built: <code>wasm-pack build --target web --release</code></p>
        </div>
      `,K}}play(){if(this.isPlaying)return;this.isPlaying=!0;let q=performance.now();this.fpsUpdateTime=q,this.lastFrameTime=q,this.stepAccumulator=0,this.frameCount=0,this.animate(q)}pause(){if(this.isPlaying=!1,this.animationFrameId!==null)cancelAnimationFrame(this.animationFrameId),this.animationFrameId=null}async step(){await this.simulation.step(),this.render(),this.updateStats()}reset(q){this.simulation.reset(q),this.render(),this.updateStats()}async animate(q){if(!this.isPlaying)return;let K=(q-this.lastFrameTime)/1000;this.lastFrameTime=q,this.stepAccumulator+=this.stepsPerSecond*K;let Q=Math.floor(this.stepAccumulator);if(this.stepAccumulator-=Q,Q>0)await this.simulation.run(Q),this.render(),this.updateStats();if(this.frameCount++,q-this.fpsUpdateTime>=1000)this.currentFps=this.frameCount,this.frameCount=0,this.fpsUpdateTime=q;this.animationFrameId=requestAnimationFrame((Z)=>this.animate(Z))}render(){let q=this.simulation.getState(),K=this.interaction.getSelection(),Q=this.interaction.getGhostPreview();this.renderer.render(q,K,Q)}updateStats(){this.ui.updateStats(this.simulation.getStep(),this.simulation.getTime(),this.simulation.totalMass(),this.currentFps)}setMode(q){if(this.interaction.setMode(q),q!=="select")this.interaction.clearSelection(),this.ui.updateSelection(!1)}updateSettings(q){this.settings={...this.settings,...q},this.renderer.updateSettings(q),this.render()}async switchBackend(q){if(await this.simulation.switchBackend(q))this.settings.backend=q,this.ui.updateBackend(q),console.log(`Switched to ${q.toUpperCase()} backend`);else this.ui.updateBackend(this.simulation.getBackend()),console.warn(`Failed to switch to ${q} backend`)}saveSelection(q){let K=this.interaction.getSelection();if(!K)return;let Q=Math.min(K.startX,K.endX),Z=Math.min(K.startY,K.endY),$=Math.abs(K.endX-K.startX),O=Math.abs(K.endY-K.startY);if($<=0||O<=0)return;let A=this.simulation.extractRegion(Q,Z,$,O);this.presetManager.savePreset(q,A),this.interaction.clearSelection(),this.ui.updateSelection(!1)}selectPreset(q){let K=Math.floor((this.simulation.getWidth()-q.region.width)/2),Q=Math.floor((this.simulation.getHeight()-q.region.height)/2);this.simulation.placeRegion(q.region,K,Q),this.render()}deletePreset(q){this.presetManager.deletePreset(q)}startPresetDrag(q,K){K.dataTransfer.effectAllowed="copy",K.dataTransfer.setData("text/plain",q.id),this.interaction.startDragFromLibrary(q,K)}exportPresets(){let q=this.presetManager.exportPresets(),K=new Blob([q],{type:"application/json"}),Q=URL.createObjectURL(K),Z=document.createElement("a");Z.href=Q,Z.download="flow-lenia-presets.json",Z.click(),URL.revokeObjectURL(Q)}importPresets(q){try{let K=this.presetManager.importPresets(q);alert(`Imported ${K} preset(s)`)}catch(K){alert(`Failed to import presets: ${K}`)}}}var z=new S;z.initialize().catch(console.error);

//# debugId=31B5AD1D115867F664756E2164756E21
